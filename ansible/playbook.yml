---
- name: Setup String Theory Landscape Explorer
  hosts: string_theory
  become: yes
  vars:
    project_dir: /root/string_theory
    data_dir: /data/polytopes
    palp_dir: /root/palp_source
    cytools_dir: /root/cytools_source
    cymyc_dir: /root/cymyc_source
    repo_url: https://github.com/ndbroadbent/string_theory_search.git
    num_workers: 12

  tasks:
    - name: Install system dependencies
      apt:
        name:
          - build-essential
          - pkg-config
          - python3-venv
          - python3-dev
          - python3-pip
          - git
          - curl
          - cmake
          - libgmp-dev
          - libmpfr-dev
          - libflint-dev
          - libppl-dev
          - m4
          - libtool
          - autoconf
        state: present
        update_cache: yes

    - name: Check if Rust is installed
      command: /root/.cargo/bin/cargo --version
      register: rust_check
      ignore_errors: yes
      changed_when: false

    - name: Install Rust
      shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      when: rust_check.rc != 0

    - name: Clone/update string_theory repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_dir }}"
        version: main
        force: yes
      register: git_clone

    - name: Create results directory
      file:
        path: "{{ project_dir }}/results"
        state: directory
        mode: '0755'

    - name: Create logs directory
      file:
        path: "{{ project_dir }}/logs"
        state: directory
        mode: '0755'

    - name: Create Python venv
      command: python3 -m venv venv
      args:
        chdir: "{{ project_dir }}"
        creates: "{{ project_dir }}/venv/bin/python"

    # ============================================
    # CYTools Installation (from source)
    # ============================================
    - name: Check if CYTools is installed
      stat:
        path: "{{ cytools_dir }}/src/cytools"
      register: cytools_check

    - name: Clone CYTools
      git:
        repo: https://github.com/LiamMcAllisterGroup/cytools.git
        dest: "{{ cytools_dir }}"
        version: main
      when: not cytools_check.stat.exists

    - name: Install CYTools dependencies
      pip:
        name:
          - numpy
          - scipy
          - pplpy
          - python-flint
          - ortools
          - tqdm
          - cygv
          - pypalp
        virtualenv: "{{ project_dir }}/venv"
        state: present

    - name: Install CYTools from source
      shell: |
        source {{ project_dir }}/venv/bin/activate
        pip install -e .
      args:
        chdir: "{{ cytools_dir }}"
        executable: /bin/bash
      when: not cytools_check.stat.exists

    # ============================================
    # cymyc Installation (JAX-based CY metrics)
    # ============================================
    - name: Check if cymyc is installed
      stat:
        path: "{{ cymyc_dir }}/cymyc"
      register: cymyc_check

    - name: Clone cymyc
      git:
        repo: https://github.com/Justin-Tan/cymyc.git
        dest: "{{ cymyc_dir }}"
        version: main
      when: not cymyc_check.stat.exists

    - name: Install cymyc dependencies (JAX ecosystem)
      pip:
        name:
          - jax
          - jaxlib
          - equinox
          - optax
          - sympy
        virtualenv: "{{ project_dir }}/venv"
        state: present

    - name: Install cymyc from source
      shell: |
        source {{ project_dir }}/venv/bin/activate
        pip install -e .
      args:
        chdir: "{{ cymyc_dir }}"
        executable: /bin/bash
      when: not cymyc_check.stat.exists

    # ============================================
    # Other Python dependencies
    # ============================================
    - name: Install remaining Python dependencies
      pip:
        name:
          - pyarrow
          - requests
          - datasets
          - huggingface_hub
        virtualenv: "{{ project_dir }}/venv"
        state: present

    # ============================================
    # PALP Installation
    # ============================================
    - name: Check if PALP is installed
      stat:
        path: "{{ palp_dir }}/poly.x"
      register: palp_check

    - name: Clone PALP
      git:
        repo: https://gitlab.com/stringstuwien/PALP.git
        dest: "{{ palp_dir }}"
        version: main
      when: not palp_check.stat.exists

    - name: Build PALP
      make:
        chdir: "{{ palp_dir }}"
        params:
          NUM_THREADS: 8
      when: not palp_check.stat.exists

    # ============================================
    # Polytope Data
    # ============================================
    - name: Create parquet directory
      file:
        path: "{{ data_dir }}/parquet"
        state: directory
        mode: '0755'

    - name: Check if download is complete
      shell: ls -1 {{ data_dir }}/parquet/*.parquet 2>/dev/null | wc -l
      register: parquet_count
      changed_when: false

    - name: Start polytope download in background
      shell: |
        source venv/bin/activate
        nohup python3 download_all_polytopes.py \
          --output-dir {{ data_dir }}/parquet \
          > {{ data_dir }}/download.log 2>&1 &
        echo $! > {{ data_dir }}/download.pid
        echo "Download started in background (PID: $(cat {{ data_dir }}/download.pid))"
      args:
        chdir: "{{ project_dir }}"
        executable: /bin/bash
      when: parquet_count.stdout | int < 32
      async: 10
      poll: 0

    # ============================================
    # Build Rust Project
    # ============================================
    - name: Build Rust project
      shell: source /root/.cargo/env && cargo build --release --bin real_physics
      args:
        chdir: "{{ project_dir }}"
        executable: /bin/bash
      register: cargo_build
      changed_when: "'Compiling' in cargo_build.stdout"

    - name: Copy run_workers.sh
      copy:
        src: ../run_workers.sh
        dest: "{{ project_dir }}/run_workers.sh"
        mode: '0755'

    # ============================================
    # Verify Installation
    # ============================================
    - name: Verify CYTools import
      shell: |
        source {{ project_dir }}/venv/bin/activate
        python3 -c "from cytools import Polytope; print('CYTools OK')"
      args:
        executable: /bin/bash
      register: cytools_verify
      changed_when: false

    - name: Verify cymyc import
      shell: |
        source {{ project_dir }}/venv/bin/activate
        python3 -c "from cymyc import alg_geo; print('cymyc OK')"
      args:
        executable: /bin/bash
      register: cymyc_verify
      changed_when: false

    - name: Print verification results
      debug:
        msg: |
          CYTools: {{ cytools_verify.stdout }}
          cymyc: {{ cymyc_verify.stdout }}

  handlers:
    - name: restart workers
      shell: pkill -f real_physics || true
